<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aspire Pipeline Viewer - Electron UI Mock</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* Window frame */
        .window {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .title-bar {
            background: #2d2d2d;
            padding: 8px 12px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            font-size: 12px;
        }

        .title-bar-title {
            flex: 1;
        }

        .window-controls {
            display: flex;
            gap: 8px;
            padding-right: 8px;
        }

        .window-control-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.2s;
        }

        .window-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window-control-btn.close:hover {
            background: #e81123;
        }

        /* Menu bar */
        .menu-bar {
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            height: 36px;
            padding: 0 12px;
            align-items: center;
            gap: 20px;
            font-size: 13px;
        }

        .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 2px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Main content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid #3e3e42;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #858585;
        }

        .workspace-section {
            padding: 12px;
            border-bottom: 1px solid #3e3e42;
        }

        .workspace-label {
            font-size: 11px;
            color: #858585;
            margin-bottom: 6px;
        }

        .current-workspace {
            padding: 8px;
            background: #094771;
            border-radius: 3px;
            font-size: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .current-workspace:hover {
            background: #0e5a8f;
        }

        .workspace-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .workspace-path {
            font-size: 11px;
            color: #858585;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .open-workspace-btn {
            width: 100%;
            padding: 6px;
            background: #0e639c;
            border: none;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .open-workspace-btn:hover {
            background: #1177bb;
        }

        .search-box {
            padding: 8px;
            background: transparent;
            border: none;
            border-bottom: 1px solid #3e3e42;
        }

        .search-input {
            width: 100%;
            padding: 6px 8px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #e0e0e0;
            border-radius: 2px;
            font-size: 12px;
        }

        .search-input::placeholder {
            color: #858585;
        }

        .step-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .step-item {
            padding: 8px 12px;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #3e3e4220;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-item:hover {
            background: #3e3e42;
        }

        .step-item.selected {
            background: #094771;
            border-left-color: #0e639c;
        }

        .step-status {
            font-size: 14px;
            width: 16px;
            flex-shrink: 0;
        }

        .step-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Center - Graph area */
        .graph-area {
            flex: 1;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .graph-toolbar {
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e42;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
        }

        .toolbar-btn {
            padding: 4px 12px;
            background: #0e639c;
            border: none;
            color: #fff;
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }

        .toolbar-btn:hover {
            background: #1177bb;
        }

        .toolbar-spacer {
            flex: 1;
        }

        .status-text {
            color: #858585;
            font-size: 11px;
        }

        .graph-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            position: relative;
            background: #1e1e1e;
        }

        .graph-wrapper {
            display: inline-block;
            transform-origin: top left;
            transition: transform 0.1s ease-out;
        }

        svg {
            display: block;
            background: transparent;
        }

        .graph-node {
            cursor: pointer;
            transition: filter 0.2s;
        }

        .graph-node:hover circle {
            filter: brightness(1.2);
        }

        .graph-node.selected circle {
            stroke: #0e639c;
            stroke-width: 3;
        }

        .graph-node text {
            pointer-events: none;
            font-size: 12px;
            text-anchor: middle;
            fill: #e0e0e0;
        }

        .graph-edge {
            stroke: #858585;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        /* Right panel - Details */
        .details-panel {
            width: 300px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .details-header {
            padding: 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 13px;
        }

        .details-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-label {
            font-size: 11px;
            font-weight: 600;
            color: #858585;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 12px;
            padding: 8px;
            background: #3c3c3c;
            border-radius: 2px;
            word-break: break-word;
        }

        .detail-list {
            list-style: none;
        }

        .detail-list-item {
            font-size: 12px;
            padding: 4px 0;
            color: #ce9178;
        }

        .detail-list-item::before {
            content: "‚Ä¢ ";
            color: #858585;
            margin-right: 4px;
        }

        .no-selection {
            color: #858585;
            font-style: italic;
            text-align: center;
            padding: 40px 12px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #464647;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .details-panel {
                width: 250px;
            }
        }

        @media (max-width: 1000px) {
            .sidebar {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="window">
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-bar-title">Aspire Pipeline Viewer</div>
            <div class="window-controls">
                <div class="window-control-btn">‚àí</div>
                <div class="window-control-btn">‚ñ°</div>
                <div class="window-control-btn close">‚úï</div>
            </div>
        </div>

        <!-- Menu Bar -->
        <div class="menu-bar">
            <div class="menu-item">File</div>
            <div class="menu-item">View</div>
            <div class="menu-item">Help</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">Workspace</div>
                <div class="workspace-section">
                    <div class="workspace-label">Current Workspace</div>
                    <div class="current-workspace">
                        <div class="workspace-name">LintingExample</div>
                        <div class="workspace-path">~/PolyGlotWork/LintingExample</div>
                    </div>
                    <button class="open-workspace-btn">Open Workspace</button>
                </div>

                <div class="sidebar-header">Steps</div>
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search steps...">
                </div>

                <div class="step-list" id="stepList">
                    <!-- Steps will be populated here -->
                </div>
            </div>

            <!-- Graph Area -->
            <div class="graph-area">
                <div class="graph-toolbar">
                    <button class="toolbar-btn" title="Reload Diagnostics">üîÑ</button>
                    <button class="toolbar-btn" title="Load from File">üìÇ</button>
                    <button class="toolbar-btn" title="Export as JSON">üíæ</button>
                    <div class="toolbar-spacer"></div>
                    <button class="toolbar-btn" id="zoomInBtn" title="Zoom In">üîç+</button>
                    <button class="toolbar-btn" id="zoomOutBtn" title="Zoom Out">üîç‚àí</button>
                    <button class="toolbar-btn" id="resetZoomBtn" title="Reset Zoom">üîç</button>
                    <span class="status-text" id="zoomLevel">100%</span>
                    <span class="status-text" id="statusText">Ready</span>
                </div>
                <div class="graph-container" id="graphContainer">
                    <div class="graph-wrapper" id="graphWrapper">
                        <svg width="2000" height="1200" id="graphSvg">
                            <!-- Graph will be drawn here -->
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Details Panel -->
            <div class="details-panel">
                <div class="details-header" id="detailsHeader">Pipeline Details</div>
                <div class="details-content" id="detailsContent">
                    <div class="no-selection">Select a step to view details</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample pipeline data
        const pipelineData = {
            id: 'aspire-pipeline',
            name: 'aspire-pipeline',
            steps: [
                {
                    id: 'install-uv-app',
                    name: 'install-uv-app',
                    description: 'Install UV dependencies for app',
                    dependencies: [],
                    resource: 'app (ExecutableContainerResource)',
                    tags: ['install']
                },
                {
                    id: 'install-app',
                    name: 'install-app',
                    description: 'Install app dependencies',
                    dependencies: ['install-uv-app'],
                    resource: 'app (ExecutableContainerResource)',
                    tags: ['install', 'build-compute']
                },
                {
                    id: 'install-frontend',
                    name: 'install-frontend',
                    description: 'Install frontend dependencies',
                    dependencies: [],
                    resource: 'frontend (ExecutableContainerResource)',
                    tags: ['install']
                },
                {
                    id: 'install',
                    name: 'install',
                    description: 'Install all dependencies',
                    dependencies: ['install-app', 'install-frontend'],
                    resource: null,
                    tags: []
                },
                {
                    id: 'lint-app',
                    name: 'lint-app',
                    description: 'Lint Python app',
                    dependencies: ['install-app'],
                    resource: 'app (ExecutableContainerResource)',
                    tags: ['lint']
                },
                {
                    id: 'lint-frontend',
                    name: 'lint-frontend',
                    description: 'Lint frontend code',
                    dependencies: ['install-frontend'],
                    resource: 'frontend (ExecutableContainerResource)',
                    tags: ['lint']
                },
                {
                    id: 'lint',
                    name: 'lint',
                    description: 'Lint all code',
                    dependencies: ['lint-app', 'lint-frontend'],
                    resource: null,
                    tags: []
                },
                {
                    id: 'test-app',
                    name: 'test-app',
                    description: 'Test app functionality',
                    dependencies: ['lint-app'],
                    resource: 'app (ExecutableContainerResource)',
                    tags: ['test']
                },
                {
                    id: 'test',
                    name: 'test',
                    description: 'Run all tests',
                    dependencies: ['lint', 'test-app'],
                    resource: null,
                    tags: []
                },
                {
                    id: 'ci',
                    name: 'ci',
                    description: 'CI Pipeline - install, lint, and test',
                    dependencies: ['install', 'lint', 'test'],
                    resource: null,
                    tags: []
                }
            ]
        };

        let selectedStep = null;
        let currentZoom = 1;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let scrollStartX = 0;
        let scrollStartY = 0;

        // Pan/drag functionality
        const graphContainer = document.getElementById('graphContainer');
        
        graphContainer.addEventListener('mousedown', (e) => {
            // Only drag with left mouse button
            if (e.button !== 0) return;
            
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            scrollStartX = graphContainer.scrollLeft;
            scrollStartY = graphContainer.scrollTop;
            graphContainer.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            
            graphContainer.scrollLeft = scrollStartX - deltaX;
            graphContainer.scrollTop = scrollStartY - deltaY;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                graphContainer.style.cursor = 'default';
            }
        });

        // Prevent text selection while dragging
        graphContainer.addEventListener('selectstart', (e) => {
            if (isDragging) e.preventDefault();
        });

        // Zoom functionality
        function setZoom(zoomLevel) {
            currentZoom = Math.max(0.2, Math.min(3, zoomLevel));
            const wrapper = document.getElementById('graphWrapper');
            wrapper.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        document.getElementById('zoomInBtn').addEventListener('click', () => {
            setZoom(currentZoom + 0.2);
        });

        document.getElementById('zoomOutBtn').addEventListener('click', () => {
            setZoom(currentZoom - 0.2);
        });

        document.getElementById('resetZoomBtn').addEventListener('click', () => {
            setZoom(1);
        });

        // Mouse wheel zoom
        document.getElementById('graphContainer').addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            setZoom(currentZoom + delta);
        }, { passive: false });

        // Populate step list
        function populateStepList() {
            const stepList = document.getElementById('stepList');
            stepList.innerHTML = pipelineData.steps.map(step => {
                const status = getStepStatus(step.id);
                return `
                    <div class="step-item" onclick="selectStep('${step.id}')" data-step-id="${step.id}">
                        <span class="step-status">${status}</span>
                        <span class="step-name">${step.name}</span>
                    </div>
                `;
            }).join('');
        }

        function getStepStatus(stepId) {
            // Simulate some completed steps
            const completed = ['install-uv-app', 'install-app', 'install-frontend', 'install'];
            if (completed.includes(stepId)) return '‚úì';
            return '‚óã';
        }

        // Select step and show details
        function selectStep(stepId) {
            selectedStep = pipelineData.steps.find(s => s.id === stepId);
            
            // Update sidebar highlighting
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.stepId === stepId) {
                    item.classList.add('selected');
                }
            });

            // Update graph highlighting
            document.querySelectorAll('.graph-node').forEach(node => {
                node.classList.remove('selected');
                if (node.dataset.stepId === stepId) {
                    node.classList.add('selected');
                }
            });

            // Update details panel
            updateDetailsPanel();
        }

        function updateDetailsPanel() {
            const content = document.getElementById('detailsContent');
            
            if (!selectedStep) {
                content.innerHTML = '<div class="no-selection">Select a step to view details</div>';
                return;
            }

            let dependenciesHtml = '';
            if (selectedStep.dependencies && selectedStep.dependencies.length > 0) {
                dependenciesHtml = `
                    <div class="detail-section">
                        <div class="detail-label">Dependencies</div>
                        <ul class="detail-list">
                            ${selectedStep.dependencies.map(dep => `<li class="detail-list-item">${dep}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            let resourceHtml = '';
            if (selectedStep.resource) {
                resourceHtml = `
                    <div class="detail-section">
                        <div class="detail-label">Resource</div>
                        <div class="detail-value">${selectedStep.resource}</div>
                    </div>
                `;
            }

            let tagsHtml = '';
            if (selectedStep.tags && selectedStep.tags.length > 0) {
                tagsHtml = `
                    <div class="detail-section">
                        <div class="detail-label">Tags</div>
                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                            ${selectedStep.tags.map(tag => `
                                <span style="background: #094771; padding: 3px 8px; border-radius: 3px; font-size: 11px;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">Name</div>
                    <div class="detail-value" style="font-weight: 500;">${selectedStep.name}</div>
                </div>
                ${selectedStep.description ? `
                    <div class="detail-section">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${selectedStep.description}</div>
                    </div>
                ` : ''}
                ${dependenciesHtml}
                ${resourceHtml}
                ${tagsHtml}
            `;
        }

        // Calculate levels for DAG layout
        function calculateLevels() {
            const levels = {};
            const visited = new Set();
            
            function getLevel(stepId) {
                if (visited.has(stepId)) return levels[stepId] ?? 0;
                visited.add(stepId);
                
                const step = pipelineData.steps.find(s => s.id === stepId);
                if (!step || !step.dependencies || step.dependencies.length === 0) {
                    return levels[stepId] = 0;
                }
                
                const depLevels = step.dependencies.map(depId => getLevel(depId));
                return levels[stepId] = Math.max(...depLevels) + 1;
            }
            
            pipelineData.steps.forEach(step => getLevel(step.id));
            return levels;
        }

        // Position nodes hierarchically
        function calculateHierarchicalPositions(levels) {
            const positions = {};
            const levelGroups = {};
            
            // Group nodes by level
            Object.entries(levels).forEach(([stepId, level]) => {
                if (!levelGroups[level]) levelGroups[level] = [];
                levelGroups[level].push(stepId);
            });
            
            const nodeWidth = 200;  // Even wider for full text
            const horizontalGap = 240;
            const verticalGap = 150;
            
            // Position nodes
            Object.entries(levelGroups).forEach(([level, nodes]) => {
                const levelNum = parseInt(level);
                const y = 50 + levelNum * verticalGap;
                const totalWidth = nodes.length * horizontalGap;
                const startX = Math.max(50, (2000 - totalWidth) / 2);
                
                nodes.forEach((nodeId, index) => {
                    positions[nodeId] = {
                        x: startX + index * horizontalGap,
                        y: y
                    };
                });
            });
            
            return positions;
        }

        // Generate consistent colors for resources
        function getResourceColor(resource) {
            if (!resource) return '#607d8b'; // Muted blue-gray for steps with no resource
            
            // Extract base resource name (e.g., "app" from "app (ExecutableContainerResource)")
            const baseResource = resource.split(' ')[0].toLowerCase();
            
            // Direct mapping for consistency - muted, modern colors
            const resourceColors = {
                'app': '#d63031',        // Muted red
                'frontend': '#0984e3',   // Muted blue
                'node': '#27ae60',       // Muted green
                'prerequisites': '#e67e22' // Muted orange
            };
            
            // Return mapped color or a generated one
            if (resourceColors[baseResource]) {
                return resourceColors[baseResource];
            }
            
            // Fallback: use muted colors for unknown resources
            const colors = [
                '#7f39fb', // Muted purple
                '#0891b2', // Muted cyan
                '#6b7280', // Muted gray
                '#be123c'  // Muted maroon
            ];
            
            let hash = 0;
            for (let i = 0; i < baseResource.length; i++) {
                hash = baseResource.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        // Smart text wrapping - split on hyphens or at max length
        function wrapStepName(name, maxCharsPerLine = 10) {
            if (name.length <= maxCharsPerLine) {
                return [name];
            }
            
            // Try to split on hyphens first
            if (name.includes('-')) {
                const parts = name.split('-');
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    const testLine = currentLine ? currentLine + '-' + part : part;
                    
                    if (testLine.length <= maxCharsPerLine) {
                        currentLine = testLine;
                    } else {
                        if (currentLine) lines.push(currentLine);
                        currentLine = part;
                    }
                }
                if (currentLine) lines.push(currentLine);
                
                return lines;
            }
            
            // Otherwise, split at max chars
            const lines = [];
            for (let i = 0; i < name.length; i += maxCharsPerLine) {
                lines.push(name.substring(i, i + maxCharsPerLine));
            }
            return lines;
        }

        // Draw graph with hierarchical DAG layout
        function drawGraph() {
            const svg = document.getElementById('graphSvg');
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#858585" />
                    </marker>
                </defs>
            `;

            // Calculate levels using topological sort
            const levels = calculateLevels();
            const positions = calculateHierarchicalPositions(levels);

            // Add shadow filter definition
            const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            if (!svg.querySelector('defs')) svg.appendChild(defs);
            
            // Shadow filter
            const shadowFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
            shadowFilter.setAttribute('id', 'shadow');
            shadowFilter.setAttribute('x', '-50%');
            shadowFilter.setAttribute('y', '-50%');
            shadowFilter.setAttribute('width', '200%');
            shadowFilter.setAttribute('height', '200%');
            
            const feGaussianBlur = document.createElementNS('http://www.w3.org/2000/svg', 'feGaussianBlur');
            feGaussianBlur.setAttribute('in', 'SourceAlpha');
            feGaussianBlur.setAttribute('stdDeviation', '4');
            
            const feOffset = document.createElementNS('http://www.w3.org/2000/svg', 'feOffset');
            feOffset.setAttribute('dx', '2');
            feOffset.setAttribute('dy', '4');
            feOffset.setAttribute('result', 'offsetblur');
            
            const feComponentTransfer = document.createElementNS('http://www.w3.org/2000/svg', 'feComponentTransfer');
            const feFuncA = document.createElementNS('http://www.w3.org/2000/svg', 'feFuncA');
            feFuncA.setAttribute('type', 'linear');
            feFuncA.setAttribute('slope', '0.3');
            feComponentTransfer.appendChild(feFuncA);
            
            const feMerge = document.createElementNS('http://www.w3.org/2000/svg', 'feMerge');
            const feMergeNode1 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
            feMergeNode1.setAttribute('in', 'offsetblur');
            const feMergeNode2 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
            feMergeNode2.setAttribute('in', 'SourceGraphic');
            feMerge.appendChild(feMergeNode1);
            feMerge.appendChild(feMergeNode2);
            
            shadowFilter.appendChild(feGaussianBlur);
            shadowFilter.appendChild(feOffset);
            shadowFilter.appendChild(feComponentTransfer);
            shadowFilter.appendChild(feMerge);
            
            defs.appendChild(shadowFilter);

            // Draw edges
            pipelineData.steps.forEach(step => {
                if (step.dependencies) {
                    step.dependencies.forEach(depId => {
                        const fromPos = positions[depId];
                        const toPos = positions[step.id];
                        if (fromPos && toPos) {
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', fromPos.x);
                            line.setAttribute('y1', fromPos.y + 30);
                            line.setAttribute('x2', toPos.x);
                            line.setAttribute('y2', toPos.y - 30);
                            line.setAttribute('class', 'graph-edge');
                            svg.appendChild(line);
                        }
                    });
                }
            });

            // Draw nodes with wider background
            pipelineData.steps.forEach(step => {
                const pos = positions[step.id];
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', 'graph-node');
                group.setAttribute('data-step-id', step.id);
                group.onclick = () => selectStep(step.id);

                // Get color based on resource
                const nodeColor = getResourceColor(step.resource);

                // Background rectangle for text - wider and more rounded
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', pos.x - 90);
                rect.setAttribute('y', pos.y - 35);
                rect.setAttribute('width', '180');
                rect.setAttribute('height', '70');
                rect.setAttribute('fill', nodeColor);
                rect.setAttribute('stroke', 'rgba(0, 0, 0, 0.3)');
                rect.setAttribute('stroke-width', '1.5');
                rect.setAttribute('rx', '12');
                rect.setAttribute('ry', '12');
                rect.setAttribute('class', 'graph-node-text-bg');
                rect.setAttribute('filter', 'url(#shadow)');
                rect.setAttribute('style', 'transition: filter 0.2s;')

                // Text label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', pos.x);
                text.setAttribute('y', pos.y - 8);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', '#ffffff');
                
                // Use smart text wrapping
                const lines = wrapStepName(step.name);
                
                lines.forEach((line, idx) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.setAttribute('x', pos.x);
                    tspan.setAttribute('dy', idx === 0 ? '0' : '1.2em');
                    tspan.textContent = line;
                    text.appendChild(tspan);
                });

                group.appendChild(rect);
                group.appendChild(text);
                svg.appendChild(group);
            });
        }

        // Search functionality
        document.querySelector('.search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.step-item').forEach(item => {
                const stepName = item.textContent.toLowerCase();
                item.style.display = stepName.includes(query) ? '' : 'none';
            });
        });

        // Initialize
        populateStepList();
        drawGraph();

        // Simulate auto-reload
        setInterval(() => {
            const statusText = document.getElementById('statusText');
            const colors = ['Ready', 'Checking...', 'Ready'];
            let colorIndex = 0;
            setInterval(() => {
                statusText.textContent = colors[colorIndex % colors.length];
                colorIndex++;
            }, 3000);
        }, 0);
    </script>
</body>
</html>
